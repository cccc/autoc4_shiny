import{mqtt_match_topic,two_digits,generateUUID}from"./utils.js";var autoc4,__AUTOC4_CONFIG_LOCATION=__AUTOC4_CONFIG_LOCATION||"config.json";$((function(){$.getJSON(__AUTOC4_CONFIG_LOCATION).done((function(e){e.debug&&e.debug.configLoaded&&console.debug("Config loaded successfully",e),autoc4=new AutoC4(e),update_time()})).fail((function(e,o){console.error("Couldn't load config.json",e,o)}))}));export class AutoC4{constructor(e){this.modules=[],this._moduleTypes={},this.config=e,this.client=new Paho.MQTT.Client(e.server||window.location.hostname,e.port||9e3,(e.clientIdPrefix||"shiny_")+generateUUID()),this.client.onMessageArrived=this.onMessage.bind(this),this.client.onConnectionLost=this.onConnectionFailure.bind(this),Promise.all(e.plugins.map(e=>import(e))).then(e=>{e.forEach(e=>e.default(this)),this.loadModules(),this.connect()}).catch(e=>console.error(e))}loadModules(){for(const e of this.config.modules)try{e.instance=this.moduleConfigToModule(e).init(this,e.options),this.modules.push(e.instance),this.config.debug&&this.config.debug.moduleLoaded&&console.debug(`Successfully initialized module of type "${e.type}".`,e)}catch(o){console.error("An error occured while initializing a module."),console.error("Module Type: ",e.type),console.error(o)}}connect(){this.client.connect({onSuccess:this.onConnect.bind(this),onFailure:this.client.onConnectionLost,mqttVersion:3})}onMessage(e){this.config.debug.message&&console.debug("MQTT message received:",e);for(let o of this.config.modules)try{o.subscribe&&o.subscribe.some(o=>mqtt_match_topic(o,e.destinationName))&&o.instance.onMessage(this,e)}catch(e){console.error("An error occured while processing a message."),console.error("Module: ",o.instance),console.error(e)}}onConnect(e){this.config.debug&&this.config.debug.connect&&console.debug("MQTT connection successfull.",e);for(let e of this.config.modules)if(e.subscribe)for(let o of e.subscribe)this.client.subscribe(o);for(let o of this.modules)try{o.onConnect(this,e)}catch(e){console.error("An error occured while handling disconnect."),console.error("Module: ",o),console.error(e)}}onConnectionFailure(e){this.config.debug&&this.config.debug.disconnect&&console.warn("MQTT connection failure, retrying in 5 seconds..",e),setTimeout((function(e){e.connect()}),5e3,this);for(let o of this.modules)try{o.onConnectionFailure(this,e)}catch(e){console.error("An error occured while handling disconnect."),console.error("Module: ",o),console.error(e)}}sendData(e,o,t=!1){let n=new Paho.MQTT.Message(o);n.destinationName=e,n.retained=t,this.client.send(n),this.config.debug&&this.config.debug.sentMessage&&console.debug("Sent MQTT Message:",n)}sendByte(e,o,t=!1){this.sendData(e,new Uint8Array(void 0===o?[0]:[o]),t)}registerModule(e,o){this._moduleTypes[e]=o}moduleConfigToModule(e){if(e.type in this._moduleTypes)return this._moduleTypes[e.type]();throw new Error(`Unknown module type: ${e.type}`)}}var update_time=function(){var e=new Date,o=two_digits(e.getDate())+"."+two_digits(e.getMonth()+1)+"."+e.getFullYear()+" "+two_digits(e.getHours())+":"+two_digits(e.getMinutes());$("#datetime").text(o),setTimeout(update_time,6e4-1e3*e.getSeconds()-e.getMilliseconds())};$("#help").click((function(e){e.preventDefault(),$("#help-display").toggle()})),$("body").on("click input change","[data-toggle=value][data-target][data-value]",(function(){document.querySelectorAll(this.getAttribute("data-target")).forEach(e=>e.value=this.getAttribute("data-value"))}));
//# sourceMappingURL=autoc4.min.js.map
