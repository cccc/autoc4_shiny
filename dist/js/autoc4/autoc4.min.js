var autoc4,mqtt_client,__AUTOC4_CONFIG_LOCATION=__AUTOC4_CONFIG_LOCATION||"config.json";$((function(){$.getJSON(__AUTOC4_CONFIG_LOCATION).done((function(e){e.debug&&e.debug.configLoaded&&console.debug("Config loaded successfully",e),autoc4=new AutoC4(e),update_time()})).fail((function(e,o){console.error("Couldn't load config.json",e,o)}))}));class AutoC4{constructor(e){this.modules=[],this.config=e,this.client=new Paho.MQTT.Client(e.server||window.location.hostname,e.port||9e3,AutoC4.generateClientId()),this.client.onMessageArrived=this.onMessage.bind(this),this.client.onConnectionLost=this.onConnectionFailure.bind(this);for(let o of e.modules)try{o.instance=AutoC4.moduleConfigToModule(o).init(this,o.options),this.modules.push(o.instance),this.config.debug&&this.config.debug.moduleLoaded&&console.debug(`Successfully loaded module of type "${o.module}".`,o)}catch(e){console.error("An error occured while initializing a module."),console.error("Module: ",o.module),console.error(e)}$("#help").click((function(e){e.preventDefault(),$("#help-display").toggle()})),$("body").on("click input change","[data-toggle=value][data-target][data-value]",(function(){document.querySelectorAll(this.getAttribute("data-target")).forEach(e=>e.value=this.getAttribute("data-value"))})),this.connect()}connect(){this.client.connect({onSuccess:this.onConnect.bind(this),onFailure:this.client.onConnectionLost,mqttVersion:3})}onMessage(e){this.config.debug.message&&console.debug("MQTT message received:",e);for(let o of this.config.modules)try{o.subscribe&&o.subscribe.some(o=>mqtt_match_topic(o,e.destinationName))&&o.instance.onMessage(this,e)}catch(e){console.error("An error occured while processing a message."),console.error("Module: ",o.instance),console.error(e)}}onConnect(e){this.config.debug&&this.config.debug.connect&&console.debug("MQTT connection successfull.",e);for(let e of this.config.modules)if(e.subscribe)for(let o of e.subscribe)this.client.subscribe(o);for(let o of this.modules)try{o.onConnect(this,e)}catch(e){console.error("An error occured while handling disconnect."),console.error("Module: ",o),console.error(e)}}onConnectionFailure(e){this.config.debug&&this.config.debug.disconnect&&console.warn("MQTT connection failure, retrying in 5 seconds..",e),setTimeout((function(e){e.connect()}),5e3,this);for(let o of this.modules)try{o.onConnectionFailure(this,e)}catch(e){console.error("An error occured while handling disconnect."),console.error("Module: ",o),console.error(e)}}sendData(e,o,t=!1){let n=new Paho.MQTT.Message(o);n.destinationName=e,n.retained=t,this.client.send(n)}sendByte(e,o,t=!1){let n=new Uint8Array(void 0===o?[0]:[o]),i=new Paho.MQTT.Message(n);i.destinationName=e,i.retained=t,this.client.send(i)}static generateClientId(){return"c4sw_yxxxxxxxxxxxxxxxxx".replace(/[xy]/g,(function(e){let o=16*Math.random()|0;return("x"==e?o:3&o|8).toString(16)}))}static registerModule(e,o){this._modules[e]=o}static moduleConfigToModule(e){return this._modules[e.module]()}}AutoC4._modules={};var update_time=function(){var e=new Date,o=two_digits(e.getDate())+"."+two_digits(e.getMonth()+1)+"."+e.getFullYear()+" "+two_digits(e.getHours())+":"+two_digits(e.getMinutes());$("#datetime").text(o),setTimeout(update_time,6e4-1e3*e.getSeconds()-e.getMilliseconds())};
//# sourceMappingURL=autoc4.min.js.map
